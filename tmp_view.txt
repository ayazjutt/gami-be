datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Network {
  id        Int     @id @default(autoincrement())
  name      String  @unique
  slug      String  @unique
  chainId   Int?    @unique

  assets    Asset[]

  @@index([slug])
}

model Asset {
  id         Int      @id @default(autoincrement())
  networkId  Int
  network    Network  @relation(fields: [networkId], references: [id], onDelete: Cascade)

  address    String
  name       String
  symbol     String
  decimals   Int
  isRemoved  Boolean  @default(false)

  maturitySnapshots MaturitySnapshot[]

  @@unique([networkId, address])
  @@index([networkId])
  @@index([symbol])
}

model MaturitySnapshot {
  id                Int      @id @default(autoincrement())
  assetId           Int
  asset             Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)

  maturityTs        DateTime
  source            String
  name              String
  symbol            String

  ibtAddress        String?
  ytAddress         String?
  ptAddress         String?

  maturityCreatedAt DateTime?
  balance           String?
  pools             Json?
  payload           Json

  createdAt         DateTime @default(now())

  // Back-reference for InputSnapshot relation
  inputSnapshots    InputSnapshot[]

  @@index([assetId, maturityTs])
}

model InputSnapshot {
  id                  Int               @id @default(autoincrement())
  maturitySnapshotId  Int
  maturitySnapshot    MaturitySnapshot  @relation(fields: [maturitySnapshotId], references: [id], onDelete: Cascade)

  metric              String
  currentValue        Decimal?          @db.Decimal(38, 18)
  previousValue       Decimal?          @db.Decimal(38, 18)
  changePercentage    Decimal?          @db.Decimal(38, 18)
  threshold           Decimal?          @db.Decimal(38, 18)

  status              String?
  alert               Boolean?          @default(false)
  source              String?
  note                String?

  createdAt           DateTime          @default(now())

  @@index([maturitySnapshotId, metric])
}

model Setting {
  id       Int      @id @default(autoincrement())
  key      String   @unique
  value    String?
  numValue Decimal? @db.Decimal(38, 18)
  notes    String?
}
